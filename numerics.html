

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tips and tricks for stable LLoCa training &mdash; LLoCa  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=9edc463e" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="api.html" />
    <link rel="prev" title="LLoCa-ParticleNet" href="more-backbones/particlenet.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            LLoCa
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="lloca-vs-lgatr.html">LLoCa vs L-GATr</a></li>
<li class="toctree-l1"><a class="reference internal" href="more-backbones/index.html">Make any network Lorentz-equivariant</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tips and tricks for stable LLoCa training</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">LLoCa</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Tips and tricks for stable LLoCa training</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/numerics.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tips-and-tricks-for-stable-lloca-training">
<h1>Tips and tricks for stable LLoCa training<a class="headerlink" href="#tips-and-tricks-for-stable-lloca-training" title="Link to this heading"></a></h1>
<p>In this section, we review the numerical choices made to ensure stable training of the Frames-Net architectures.
The information contained in this section is also carefully discussed in the appendices of the <a class="reference external" href="https://arxiv.org/pdf/2505.20280">LLoCa paper</a>.
All the methods are implemented in the package and can be easily accessed as class options.</p>
<section id="regularizing-input-particles">
<h2>Regularizing input particles<a class="headerlink" href="#regularizing-input-particles" title="Link to this heading"></a></h2>
<p>Most particles in an LHC setting can be considered massless as the typical energy scale is much larger than the mass of single particles.
When operating on four-momenta, the particle masses are often assumed to be zero or can be modified due to numerical underflows,
leading to particles with zero-norm four-momenta. Since zero-norm vectors can cause downstream instabilities in the <cite>framesnet</cite>, we enforce a minimal
particle mass <span class="math notranslate nohighlight">\(m_\epsilon\)</span> by increasing the energy of all input particles <span class="math notranslate nohighlight">\(p_i\)</span> as
$$E’ = \sqrt{m_{\epsilon}^2 + E^2},$$
hence <span class="math notranslate nohighlight">\(m'^2 = m_\epsilon^2 + m^2\)</span>.
We use <span class="math notranslate nohighlight">\(m_\epsilon=10^{-5}\)</span> and <span class="math notranslate nohighlight">\(m_\epsilon=5\cdot 10^{-3}\)</span> for the amplitude regression and tagging experiments, respectively.
In our tests, we observe a large plateau of stable <span class="math notranslate nohighlight">\(m_\epsilon\)</span> values and we ultimately select the smallest viable value.
Performance typically degrades for <span class="math notranslate nohighlight">\(m_\epsilon\geq 1\)</span>. The units are in standardized space, meaning that the regularization is applied
after rescaling the input four-momenta to <span class="math notranslate nohighlight">\(\mathcal{O}(1)\)</span> numbers.</p>
</section>
<section id="predicting-stable-local-frames">
<h2>Predicting stable local frames<a class="headerlink" href="#predicting-stable-local-frames" title="Link to this heading"></a></h2>
<p>We carefully design the construction of local frames to avoid numerical instabilities during training.
Here, we describe the main aspects for the MLP Frames-Net but they apply also to the LGATr and PELICAN Frames-Nets.
The vectors <span class="math notranslate nohighlight">\(v_{i,k}\)</span>, needed to construct a local frame for each particle <span class="math notranslate nohighlight">\(i\)</span>, are predicted using
$$v_{i,k} = \sum_{j=1}^N \mathrm{softmax}\Big( \varphi_k(s_i, s_j, \langle p_i, p_j\rangle )\Big) \frac{p_i + p_j}{\|p_i+p_j\| + \epsilon} \quad  \text{ for } k = 0,1,2.$$</p>
<p>We have identified several techniques to avoid numerical instabilities already at initialization and throughout the training:</p>
<ol class="arabic simple" start="0">
<li><p>(optional) boosting the input particles to a common reference frame, e.g. the center-of-mass frame, can help in case of extremely boosted inputs. This step improves performance for jet tagging in a few cases.</p></li>
<li><p>we include a <span class="math notranslate nohighlight">\(\mathrm{softmax}\)</span> operation to prevent any negative-norm vectors in the process, leaving the transformation into spacelike vectors for three out of four vectors to the Gram-Schimdt orthonormalization and the local frame construction;</p></li>
<li><p>the usage of regulator masses to enforce a lower limit on the norms of the input particles <span class="math notranslate nohighlight">\(p_i\)</span> already described above;</p></li>
<li><p>we multiply by <span class="math notranslate nohighlight">\(p_i+p_j\)</span> instead of simply <span class="math notranslate nohighlight">\(p_i\)</span> because <span class="math notranslate nohighlight">\(p_i+p_j\)</span> is typically not strongly boosted;</p></li>
<li><p>we perform an additional normalization step on the final predictions: $$v_{i,k} \gets v_{i,k} \Big/ \sqrt{\sum_{j=1}^N \| v_{i,k}\|^2}.$$</p></li>
</ol>
<p>These choices improve the numerical stability of the local frames prediction but are not necessary to ensure the correct Lorentz-equivariant
behavior of the Frames-Net. For instance, in (1.) the softmax gives us the best results but other functions ensuring positive norms could be used instead.
Improving the Frames-Net performance and stability is an active area of research and we expect further improvements in the future.
For example, the PELICAN and the L-GATr Frames-Nets are strict generalizations of the MLP Frames-Net which could be further improved.</p>
</section>
<section id="regularizing-predicted-vectors">
<h2>Regularizing predicted vectors<a class="headerlink" href="#regularizing-predicted-vectors" title="Link to this heading"></a></h2>
<p>Even with the above precautions, in rare cases the predicted vectors <span class="math notranslate nohighlight">\(v_{i,k}\)</span> might produce ill-defined local frames.
We apply the following regularizations to ensure that the training remains stable.</p>
<p><strong>NB:</strong> These regularizations break Lorentz-equivariance. They are meant to be applied in rare cases
or only at initialization such that the training remains stable. The application of these regularizations to a large
fraction of particles in the batch indicates that the numerics of the input should be improved.
We provide trackers in the Frames-Net implementations to monitor how often these regularizations are applied. Similarly,
we recommend monitoring the <span class="math notranslate nohighlight">\(\gamma\)</span> factors of the boosts to detect potential numerical issues.
The <a class="reference internal" href="generated/lloca.framesnet.equi_frames.LearnedFrames.html#lloca.framesnet.equi_frames.LearnedFrames" title="lloca.framesnet.equi_frames.LearnedFrames"><code class="xref py py-class docutils literal notranslate"><span class="pre">LearnedFrames</span></code></a> class returns the tracker if <code class="docutils literal notranslate"><span class="pre">return_trackers=True</span></code>.</p>
<p>We verify that <span class="math notranslate nohighlight">\(v_0\)</span> is not lightlike, as this would lead to an ill-defined boost <span class="math notranslate nohighlight">\(B\)</span>.
We check that
$$\|v_0\| &lt; \epsilon_{\text{lightlike}} \qquad\text{with}\qquad \epsilon_{\text{lightlike}}=10^{-16}.$$
If this condition is not satisfied, we replace <span class="math notranslate nohighlight">\(v_0\)</span> with <span class="math notranslate nohighlight">\(v_0 + \epsilon_\text{lightlike}\delta\)</span>, with <span class="math notranslate nohighlight">\(\delta\)</span>
a timelike noise four-vector constructed by sampling the components of a vector from
a Gaussian distribution, taking the absolute value, and setting the energy
component to two times the spatial norm.</p>
<p>Then, the <span class="math notranslate nohighlight">\(\mathrm{SO}(3)\)</span> Gram-Schmidt orthogonalization used to construct the
rotation matrix <span class="math notranslate nohighlight">\(R\)</span> requires linearly independent vectors. We numerically control
this condition by verifying that
$$\|\vec w_1 \times \vec w_2\| &lt; \epsilon_{\text{collinear}}.$$
If a regularization is needed, we replace both vectors with
$$\vec w_1 + \epsilon_{\text{collinear}}\vec \delta_1 \qquad\text{and}\qquad \vec w_2 + \epsilon_{\text{collinear}}\vec \delta_2,$$
where <span class="math notranslate nohighlight">\(\vec \delta_{1,2}\)</span> are random normal directions, i.e.~:math:<cite>delta_i simmathcal{N}(0,1)</cite>.
This choice of regularization allows for safe prediction of local frames also in
the edge case of <span class="math notranslate nohighlight">\(N&lt;3\)</span> input particles. For both <span class="math notranslate nohighlight">\(N=1\)</span> and <span class="math notranslate nohighlight">\(N=2\)</span>, the cross product
between <span class="math notranslate nohighlight">\(\vec w_1\)</span> and <span class="math notranslate nohighlight">\(\vec w_2`\)</span> would be zero; the regularization ensures that
the vectors are linearly independent.
In our studies, we use <span class="math notranslate nohighlight">\(\epsilon_\text{collinear}=10^{-16}\)</span>, and we do not observe regularization throughout trainings besides a few
occurrences at initialization, validating the numerical stability of our orthogonalization method.</p>
<p>Both regularizations are implemented in the LLoCa package. The default values are set to the minimum epsilon which can be represented
in the chosen floating point precision. User-defined values can be set in the <a class="reference internal" href="generated/lloca.framesnet.equi_frames.LearnedPDFrames.html#lloca.framesnet.equi_frames.LearnedPDFrames" title="lloca.framesnet.equi_frames.LearnedPDFrames"><code class="xref py py-class docutils literal notranslate"><span class="pre">LearnedPDFrames</span></code></a> class.</p>
<p>The text above refers to the <a class="reference internal" href="generated/lloca.framesnet.equi_frames.LearnedPDFrames.html#lloca.framesnet.equi_frames.LearnedPDFrames" title="lloca.framesnet.equi_frames.LearnedPDFrames"><code class="xref py py-class docutils literal notranslate"><span class="pre">LearnedPDFrames</span></code></a> class. It is also possibile to orthogonalize four-vectors directly in Minkowski space
and we implement this option in the class <a class="reference internal" href="generated/lloca.framesnet.equi_frames.LearnedSO13Frames.html#lloca.framesnet.equi_frames.LearnedSO13Frames" title="lloca.framesnet.equi_frames.LearnedSO13Frames"><code class="xref py py-class docutils literal notranslate"><span class="pre">LearnedSO13Frames</span></code></a>. However, this approach is less numerically stable and requires additional
regularizations to explicitly take into account coplanar vectors. Although the two approaches are mathematically equivalent, we recommend using the <a class="reference internal" href="generated/lloca.framesnet.equi_frames.LearnedPDFrames.html#lloca.framesnet.equi_frames.LearnedPDFrames" title="lloca.framesnet.equi_frames.LearnedPDFrames"><code class="xref py py-class docutils literal notranslate"><span class="pre">LearnedPDFrames</span></code></a> class.</p>
</section>
<section id="gram-schimdt-orthonormalization-in-3d">
<h2>Gram-Schimdt orthonormalization in 3D<a class="headerlink" href="#gram-schimdt-orthonormalization-in-3d" title="Link to this heading"></a></h2>
<p>For completeness, we report here the numerical details of the <span class="math notranslate nohighlight">\(\mathrm{SO}(3)\)</span> Gram-Schmidt orthonormalization used in the local frame construction.
<span class="math notranslate nohighlight">\(\mathrm{GS3}(\vec w_1, \vec w_2)\)</span> takes the space components of the predicted vectors after applying the learned boost.
The resulting vectors <span class="math notranslate nohighlight">\(\vec e_1\)</span>, <span class="math notranslate nohighlight">\(\vec e_2\)</span>, and <span class="math notranslate nohighlight">\(\vec e_3\)</span> are orthonormal, i.e. they satisfy <span class="math notranslate nohighlight">\(\vec e_i \cdot \vec e_j = \delta_{ij}\)</span>.</p>
<p><strong>GS(3):</strong></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
\operatorname{norm}(\vec w) = \frac{\vec w}{\|\vec w\| + \epsilon} \qquad
\vec e_1 &amp;= \operatorname{norm}\left(\vec w_1 \right),\notag \\
\vec e_2 &amp;= \operatorname{norm}\left(\vec w_2 - \vec e_1 (\vec w_2 \cdot \vec e_1)\right), \notag\\
\vec e_3 &amp;= \vec e_1 \times \vec e_2.
\label{eq:gram-schmidt}
\end{align}\end{split}\]</div>
<p>We use <span class="math notranslate nohighlight">\(\epsilon = 10^{-15}\)</span>, and <span class="math notranslate nohighlight">\(\times\)</span> denotes the cross product.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="more-backbones/particlenet.html" class="btn btn-neutral float-left" title="LLoCa-ParticleNet" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="api.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Jonas Spinner.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>